<?php
header("Content-type: text/html; charset=utf-8");

class STC_Attendance extends CI_Model {

	function __construct() {

		parent::__construct();
    $this->id = $this->phpsession->get( 'id', 'stc' );
    $this->name = $this->phpsession->get( 'name', 'stc' );
    $this->lv = $this->phpsession->get( 'lv', 'stc' );
    $this->cnum = $this->phpsession->get( 'cnum', 'stc' );
    $this->seq = $this->phpsession->get( 'seq', 'stc' );
	}

	//사용자 가져오기
	function attendance_user(){
		// $sql = "SELECT u.user_name, u.user_duty,au.user_seq, am.card_num,am.date AS workdate,am.ws_time as wstime,am.wc_time as wctime,am.ws_ip_address,am.wc_ip_address,am.update_time,au.ws_time ,au.wc_time
		// FROM attendance_manual as am LEFT JOIN attendance_user AS au ON am.card_num = au.card_num LEFT JOIN user AS u ON au.user_seq = u.seq
		// WHERE u.user_id ='{$this->id}'  AND left(am.date,6) = '{$date}'";

		// $sql = "SELECT u.user_name, u.user_duty,au.user_seq,am.seq ,am.card_num,am.date AS workdate,am.ws_time as wstime,am.wc_time as wctime,am.ws_ip_address,am.wc_ip_address,am.update_time,am.official_ws_time as ws_time ,am.official_wc_time as wc_time,am.status
		// FROM attendance_manual as am LEFT JOIN attendance_user AS au ON am.card_num = au.card_num LEFT JOIN user AS u ON au.user_seq = u.seq
		// WHERE u.user_id ='{$this->id}'";

		$sql = "SELECT * FROM adt_attendance WHERE u_seq = {$this->seq}";


		$query = $this->db->query($sql);

		if ($query->num_rows() <= 0) {
			return false;
		} else {
			return $query->result_array();
		}
	}

  function attendance_info() {
    $sql = "SELECT u.user_name, au.card_num, au.ws_time as designate_ws, au.wc_time as designate_wc from attendance_user au JOIN user u ON au.user_seq = u.seq where user_seq='{$this->seq}'";
    $query = $this->db->query($sql);
    if ($query->num_rows() <= 0) {
      return false;
    } else {
      return $query->row_array() ;
    }
  }

	function attendance_data($date,$card_num){
		$sql = "SELECT * from attendance_manual where card_num='{$card_num}' and date = {$date}";
		$query = $this->db->query($sql);
		// echo $sql."<br>";
		if($query->num_rows()<=0){
			return false;
		} else {
			return $query->row_array();
		}
	}

	function user_group() {
		$sql = "SELECT user_group from user where seq='{$this->seq}'";
		$query = $this->db->query($sql);
		if ($query->num_rows() <= 0) {
		return false;
		} else {
		return $query->row_array() ;
		}
	}

	//휴가사용현황
	function annual_usage_status(){
		$sql =" SELECT eaa.*,u.user_name FROM electronic_approval_annual as eaa
		left join user AS u
		on eaa.user_id = u.user_id WHERE annual_status = 'Y' and eaa.user_id='{$this->id}'";

	  $query = $this->db->query($sql);

	  if ($query->num_rows() <= 0) {
		  return false;
	  } else {
		  return $query->result_array();
	  }
	}

	// 연차관리
	function annual_management() {
		$sql = "SELECT ua.*, u.user_name,u.user_group,u.join_company_date,
			(SELECT COUNT(*) FROM electronic_approval_annual WHERE user_id = u.user_id AND (annual_status IS NULL || annual_status = '') ) as approval_cnt
			FROM user_annual AS ua LEFT JOIN user as u ON ua.user_seq = u.seq where u.user_id='{$this->id}' order by u.join_company_date,u.seq";

		$query = $this->db->query( $sql);

		if ($query->num_rows() <= 0) {
			return false;
		} else {
			return $query->result_array();
		}
	}

	//휴가사용내역
	function annual_usage_status_list($searchkeyword){
		$searchstring = "";
		if ($searchkeyword != "") {
			$searchkeyword = explode(',',$searchkeyword);
			if(trim($searchkeyword[0])!=''){ //사용기간 시작
				$searchstring .= " and eaa.annual_start_date >= '{$searchkeyword[0]}'";
			}
			if(trim($searchkeyword[1])!=''){ //사용기간 끝
				$searchstring .= " and eaa.annual_end_date <= '{$searchkeyword[1]}'";
			}
			if(trim($searchkeyword[2])!=''){ //전자결재상태
				$searchstring .= " and ead.approval_doc_status = '{$searchkeyword[2]}'";
			}
			// if(trim($searchkeyword[4])!=''){ //검색어
			// 	$searchstring .= " and {$searchkeyword[3]} like '%{$searchkeyword[4]}%'";
			// }
			if(trim($searchkeyword[3])!=''){//휴가항목
				$searchstring .= " and eaa.annual_type = '{$searchkeyword[3]}'";
			}
		}else{
			$searchstring = " and eaa.annual_start_date between DATE_FORMAT(CURDATE(), '%Y-%m-01') and curdate()";
		}
		$sql ="SELECT eaa.*,u.user_name,u.user_group,user_duty,ead.approval_doc_status FROM electronic_approval_annual as eaa left join user AS u
		on eaa.user_id = u.user_id
		left join electronic_approval_doc as ead
		on eaa.approval_doc_seq = ead.seq
		WHERE u.user_id = '{$this->id}' {$searchstring}  order by annual_start_date";

		$query = $this->db->query($sql);

		if ($query->num_rows() <= 0) {
			return false;
		} else {
			return $query->result_array();
		}
	}

function get_pgroup(){
	$sql="SELECT IF(groupName = '기술연구소', groupName, parentGroupName) pgroup FROM user_group GROUP BY pgroup";
	$query = $this->db->query($sql);
	if ($query->num_rows() <= 0) {
		return false;
	} else {
		return $query->result_array();
	}

}

function working_hours_biz($sdate, $edate, $serch_group = ""){

if($serch_group != ""){
	$group_keyword = " WHERE user_group = '{$serch_group}'";

}else{
	$group_keyword = "";
}

$sql = "SELECT d.card_num, d.user_name, d.pgroup, d.user_group,
SEC_TO_TIME(TRUNCATE(SUM(d.standard_time), 0)) AS work_time,
SEC_TO_TIME(TRUNCATE(SUM(d.over_time), 0)) AS over_time,
SEC_TO_TIME(TRUNCATE((SUM(d.standard_time) + SUM(d.over_time)), 0)) AS total_time,
SEC_TO_TIME(TRUNCATE(SUM(d.minus_time),0)) AS minus_time,
SEC_TO_TIME(TRUNCATE((TIME_TO_SEC('40:00:00') - SUM(d.standard_time)),0)) AS rest_work_time,
SEC_TO_TIME(TRUNCATE((TIME_TO_SEC('12:00:00') - SUM(d.over_time)),0)) AS rest_over_time,
d.user_seq
FROM
(SELECT c.*,
CASE
	WHEN work_time IS NULL THEN 0
	WHEN work_time >='08:00:00' THEN TIME_TO_SEC('08:00:00')
	ELSE TIME_TO_SEC(work_time)
END AS standard_time,
IF(work_time >='08:00:00', TIME_TO_SEC(TIMEDIFF(work_time, '08:00:00')), 0) AS over_time
FROM(SELECT b.*,
CASE
	WHEN date_type = 'h' THEN null
	WHEN `status` = '오후반차' || `status` = '오전반차' THEN '04:00'
	WHEN `status` = '연차' THEN '08:00'
	WHEN TIMEDIFF(offtime, ontime) >= '08:00' THEN TIMEDIFF(TIMEDIFF(offtime, ontime), '01:00')
	WHEN TIMEDIFF(offtime, ontime) >= '04:00' THEN TIMEDIFF(TIMEDIFF(offtime, ontime), '00:30')
	ELSE TIMEDIFF(offtime, ontime)
END AS work_time
FROM
(SELECT a.*,
IF(a.stime > a.official_ws_time || a.stime IS NULL, a.stime, a.official_ws_time) AS ontime,
off.offtime,u.user_name, u.seq as user_seq, u.user_group, u.pgroup,
IF(TIMEDIFF(a.stime, a.official_ws_time) > 0, TIME_TO_SEC(TIMEDIFF(a.stime, a.official_ws_time)), NULL) AS minus_time
FROM (SELECT card_num, `status`, DATE_FORMAT(`date`, '%Y-%m-%d') AS wdate,
date_type,
DATE_FORMAT(STR_TO_DATE(ws_time, '%Y%m%d%H%i%s'),'%H:%i') AS stime,
official_ws_time, official_wc_time
FROM attendance_manual
WHERE DATE_FORMAT(`date`, '%Y-%m-%d') >= '{$sdate}' AND DATE_FORMAT(`date`, '%Y-%m-%d') <= '{$edate}') AS a
LEFT JOIN
(SELECT DATE_FORMAT(ATime, '%Y-%m-%d') AS wdate,
MAX(DATE_FORMAT(STR_TO_DATE(ATime, '%Y%m%d%H%i%s'),'%H:%i')) AS offtime, CardNo AS card_num
FROM T_SECOM_ALARM
WHERE DATE_FORMAT(ATime, '%Y-%m-%d') >= '{$sdate}' AND DATE_FORMAT(ATime, '%Y-%m-%d') <= '{$edate}'
GROUP BY wdate, CardNo) AS off
ON a.card_num = off.card_num AND a.wdate = off.wdate
JOIN
(SELECT a.*, au.card_num
FROM (SELECT u.seq, user_name, user_group, IF(u.user_group = '기술연구소', u.user_group, parentGroupName) AS pgroup FROM user as u
JOIN user_group AS ug
ON u.user_group = ug.groupName
WHERE quit_date is NULL) AS a
LEFT JOIN attendance_user AS au
ON a.seq = au.user_seq
WHERE pgroup != '기술본부') AS u
ON a.card_num = u.card_num) AS b) AS c) AS d
{$group_keyword}
GROUP BY card_num
ORDER BY user_group, user_seq";

$query = $this->db->query($sql);
// var_dump($query->result_array());
if ($query->num_rows() <= 0) {
	return false;
} else {
	return $query->result_array();
}

	}

function working_hours_tech($sdate,$edate){
	$sql="SELECT d.card_num, d.user_name, d.pgroup,
SEC_TO_TIME(TRUNCATE(SUM(d.standard_time), 0)) AS work_time,
SEC_TO_TIME(TRUNCATE(SUM(d.over_time), 0)) AS over_time,
SEC_TO_TIME(TRUNCATE((SUM(d.standard_time) + SUM(d.over_time)), 0)) AS total_time,
SEC_TO_TIME(TRUNCATE((TIME_TO_SEC('40:00:00') - SUM(d.standard_time)),0)) AS rest_work_time,
SEC_TO_TIME(TRUNCATE((TIME_TO_SEC('12:00:00') - SUM(d.over_time)),0)) AS rest_over_time,
user_seq
FROM(SELECT c.*,
CASE
	WHEN date_type = 'h' THEN null
	WHEN work_time IS NULL THEN 0
	WHEN work_time >='08:00:00' THEN TIME_TO_SEC('08:00:00')
	ELSE TIME_TO_SEC(work_time)
END AS standard_time,
IF(work_time >='08:00:00', TIME_TO_SEC(TIMEDIFF(work_time, '08:00:00')), 0) AS over_time
FROM (SELECT b.card_num, b.`status`, b.wdate, b.date_type, b.user_name, b.pgroup, b.tech_time, b.biztime, b.user_seq,
CASE
	-- WHEN date_type = 'h' THEN null
	WHEN `status` = '오후반차' || `status` = '오전반차' THEN '04:00'
	WHEN `status` = '연차' THEN '08:00'
	WHEN b.work_time >= '08:00' THEN TIMEDIFF(b.work_time, '01:00')
	WHEN b.work_time >= '04:00' THEN TIMEDIFF(b.work_time, '00:30')
	ELSE b.work_time
END AS work_time
FROM
(SELECT biz.*, doc.total_time AS tech_time, TIMEDIFF(biz.offtime, biz.ontime) AS biztime,
SEC_TO_TIME(TRUNCATE(IF(doc.total_time IS NULL, 0, doc.total_time) + TIME_TO_SEC(IF(TIMEDIFF(biz.offtime, biz.ontime) IS NULL, 0, TIMEDIFF(biz.offtime, biz.ontime))),0)) AS work_time
FROM
(SELECT a.*,
IF(a.stime > a.official_ws_time || a.stime IS NULL, a.stime, a.official_ws_time) AS ontime,
IF(a.official_ws_time > off.offtime, a.official_ws_time, off.offtime) AS offtime,
u.user_name, u.seq as user_seq, u.user_group, u.pgroup
FROM (SELECT card_num, `status`, DATE_FORMAT(`date`, '%Y-%m-%d') AS wdate,
date_type,
DATE_FORMAT(STR_TO_DATE(ws_time, '%Y%m%d%H%i%s'),'%H:%i') AS stime,
official_ws_time, official_wc_time
FROM attendance_manual
WHERE DATE_FORMAT(`date`, '%Y-%m-%d') >= '{$sdate}' AND DATE_FORMAT(`date`, '%Y-%m-%d') <= '{$edate}') AS a
LEFT JOIN
(SELECT DATE_FORMAT(ATime, '%Y-%m-%d') AS wdate,
MAX(DATE_FORMAT(STR_TO_DATE(ATime, '%Y%m%d%H%i%s'),'%H:%i')) AS offtime, CardNo AS card_num
FROM T_SECOM_ALARM
WHERE DATE_FORMAT(ATime, '%Y-%m-%d') >= '{$sdate}' AND DATE_FORMAT(ATime, '%Y-%m-%d') <= '{$edate}'
GROUP BY wdate, CardNo) AS off
ON a.card_num = off.card_num AND a.wdate = off.wdate
JOIN
(SELECT a.*, au.card_num
FROM (SELECT u.seq, user_name, user_group, IF(u.user_group = '기술연구소', u.user_group, parentGroupName) AS pgroup FROM user as u
JOIN user_group AS ug
ON u.user_group = ug.groupName
WHERE quit_date is NULL) AS a
LEFT JOIN attendance_user AS au
ON a.seq = au.user_seq
WHERE pgroup = '기술본부') AS u
ON a.card_num = u.card_num) AS biz
LEFT JOIN
(SELECT a.div_engineer_seq AS user_seq, a.doc_seq, a.workdate,
SUM(a.total_time) AS total_time, a.start_time, a.end_time, card.card_num, card.ontime,
IF(card.ontime >= card.offtime, card.ontime, card.offtime) AS offtime
FROM
(SELECT
SUBSTRING_INDEX (SUBSTRING_INDEX(tech.engineer_seq,',',numbers.n),',',-1) as div_engineer_seq,
tech.doc_seq, tech.workdate,
TIME_TO_SEC(tech.total_time) AS total_time, tech.start_time, tech.end_time, tech.handle
from
   (select  1 n union  all  select 2
    union  all  select  3  union  all select 4
    union  all  select  5  union  all  select  6) numbers
JOIN (SELECT seq AS doc_seq, DATE_FORMAT(income_time, '%Y-%m-%d') AS workdate, engineer_seq,
total_time, start_time, end_time, handle
FROM tech_doc_basic
WHERE DATE_FORMAT(income_time, '%Y-%m-%d') >= '{$sdate}'
AND DATE_FORMAT(income_time, '%Y-%m-%d') <= '{$edate}') AS tech
ON CHAR_LENGTH ( tech.engineer_seq ) - CHAR_LENGTH ( REPLACE ( tech.engineer_seq ,  ',' ,  '' )) >= numbers . n-1
WHERE SUBSTRING_INDEX (SUBSTRING_INDEX(tech.engineer_seq,',',numbers.n),',',-1) != '') AS a
LEFT JOIN
(SELECT a.*,
IF(a.stime > a.official_ws_time || a.stime IS NULL, a.stime, a.official_ws_time) AS ontime,
off.offtime , au.user_seq
FROM (SELECT card_num, DATE_FORMAT(`date`, '%Y-%m-%d') AS wdate,
DATE_FORMAT(STR_TO_DATE(ws_time, '%Y%m%d%H%i%s'),'%H:%i') AS stime,
official_ws_time, official_wc_time
FROM attendance_manual
WHERE DATE_FORMAT(`date`, '%Y-%m-%d') >= '{$sdate}' AND DATE_FORMAT(`date`, '%Y-%m-%d') <= '{$edate}') AS a
LEFT JOIN
(SELECT DATE_FORMAT(ATime, '%Y-%m-%d') AS wdate,
MAX(DATE_FORMAT(STR_TO_DATE(ATime, '%Y%m%d%H%i%s'),'%H:%i')) AS offtime, CardNo AS card_num
FROM T_SECOM_ALARM
WHERE DATE_FORMAT(ATime, '%Y-%m-%d') >= '{$sdate}' AND DATE_FORMAT(ATime, '%Y-%m-%d') <= '{$edate}'
GROUP BY wdate, CardNo) AS off
ON a.card_num = off.card_num AND a.wdate = off.wdate
JOIN
attendance_user AS au
ON a.card_num = au.card_num) AS card
ON a.div_engineer_seq = card.user_seq AND a.workdate = card.wdate
WHERE card.ontime IS NULL || !(a.start_time < card.offtime AND a.end_time > card.ontime)
GROUP BY a.workdate, a.div_engineer_seq)AS doc
ON biz.wdate = doc.workdate AND biz.card_num = doc.card_num) AS b) AS c ) AS d
GROUP BY card_num
ORDER BY FIELD(user_name, '김갑진') DESC, user_seq ASC";

$query = $this->db->query($sql);
// var_dump($query->result_array());
if ($query->num_rows() <= 0) {
	return false;
} else {
	return $query->result_array();
}

}




}
?>
