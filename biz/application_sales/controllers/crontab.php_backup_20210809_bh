<?php
header("Content-type: text/html; charset=utf-8");

class Crontab extends CI_Controller {

	function __construct() {
		parent::__construct();
		$this->load->Model("STC_Crontab");
	}

	// 공휴일 저장 크론
	function holiday_crontab(){

    $service_key = "64MNVtaO1eTfTnjoRxWoym8WuBjnsF9SYFZfvDnGdq9l08UyjAccxkB9K8Ik5sDxbtX3GJu22hACTnOvcfxdBQ%3D%3D";

		$time = time();
		$date = explode("-",date("Y-m",strtotime("+1 month", $time)));

		$year = $date[0];
		$month = $date[1];

    $url = "http://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService/getRestDeInfo?serviceKey=".$service_key."&solYear=".$year."&solMonth=".$month;

		echo $url;

    $data = file_get_contents($url);
    $xml = simplexml_load_string($data);
    $items = $xml->body[0]->items->item;

    $count = count($items);

    if ($count>0){
      for($i=0;$i<$count;$i++){
        $holiday[$i]['dateName'] = $items[$i]->dateName;
        $holiday[$i]['locdate'] = $items[$i]->locdate;
      }

      echo "<pre>";
      echo var_dump($holiday);
      echo "</pre>";

			foreach($holiday as $h){
				$locdate = $h['locdate'];
				$dateName = $h['dateName'];
				$holiday_count = $this->STC_Crontab->holiday_count($locdate)->cnt;
				if ($holiday_count == 0) {
					$this->STC_Crontab->holiday_insert($locdate, $dateName);
				}
			}
    } else {
      echo "공휴일 없음";
    }

  }


	// 근퇴 생성 크론탭
	function attendance_manual_input() {

		$date = date('Ymd');
		$beforeDay = date("Ymd", strtotime($date." -1 day"));

		$before_attendance = $this->STC_Crontab->before_attendance($beforeDay);

		foreach ($before_attendance as $ba) {

			if($ba['ws_time']=="" || $ba['wc_time']=="") {
				$this->STC_Crontab->update_before_attendance($ba['seq'],'미처리');
			}

		}


		$attendance_user = $this->STC_Crontab->attendance_user();

		foreach($attendance_user as $au) {

			$official_time = $this->STC_Crontab->official_time($au['card_num']);

			$data = array(
				'card_num' => $au['card_num'],
				'date' => $date,
				// 'status' => $status,
				// 'date_type' => $date_type,
				'official_ws_time' => $official_time['ws_time'],
				'official_wc_time' => $official_time['wc_time']
			);

			$attendance_count = $this->STC_Crontab->attendance_count($au['card_num'], $date)->cnt;
			if ($attendance_count == 0) {
				$this->STC_Crontab->attendance_input($data);
			}
		}

	}


}
?>
