<?php
include $this->input->server('DOCUMENT_ROOT')."/include/base.php";
include $this->input->server('DOCUMENT_ROOT')."/include/mail_header.php";
include $this->input->server('DOCUMENT_ROOT')."/include/mail_side.php";
 ?>


 <link rel="stylesheet" href="<?php echo $misc; ?>/daumeditor-7.4.9/css/editor.css" type="text/css" charset="utf-8"/>
 <link rel="stylesheet" href="<?php echo $misc; ?>/css/style.css" type="text/css" charset="utf-8"/>
 <script src="<?php echo $misc; ?>/daumeditor-7.4.9/js/editor_loader.js" type="text/javascript" charset="utf-8"></script>
 <!-- <script type="text/javascript" src="/misc/js/board/board_script_daum.js"></script> -->
 <!-- <script src="/misc/js/jquery.bpopup-0.1.1.min.js"></script> -->

 <!-- 넓이 높이 조절 -->
 <style>

    /* #recipient{
      background-color: pink;
    } */

  #group_table td {
    border-bottom:1px solid #DFDFDF;
    height: 30px;
  }

  #group_table tr:hover {
    background-color: #e4f6f7;
  }

  .user_selected{
      background-color:#c9f2f5;
  }


  #modal_h{
    height:15%;
    width: 100%;
  }

  #modal_b{
    height:75%;
    width: 100%;
    display: flex;

  }

  #modal_f{
    height:10%;
    width: 100%;
  }

  .mb_c{
    border: 1px solid #DFDFDF;
    border-radius: 3px;
    opacity: 1;
  }

  #modal_b table{
    width:100%;
    border-spacing:0px;
  }

  .to_contain{
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  /* .to_item{
    display: flex;
    height: 33%;
  } */

  #adress_modal {
    display:none;
    padding: 20px;
    border-radius: 3px;
    background-color: white;
    min-width: 400px;
    min-height: 500px;
    width:40vw;
    height: 70vh;
  }

  #adress_modal input {
    appearance:none;
    border:none;
    border: solid 1px;
    height:30px;
    border-radius:3px;
    border-color:#DFDFDF;
    /* background:url(/misc/img/icon/search.png) no-repeat 98% 50% #fff; */
		/* background-size: 20px; */
  }

  #adress_modal input::placeholder {
    color: #B0B0B0;
  }

  #adress_modal .btn {
    height:35px;
    color:#B0B0B0;
    width:auto;
    padding-left:10px;
    padding-right:10px;
    padding-top:7px;
    float:left;
    display:table-cell;
    vertical-align: middle;
    border-right:thin solid #DFDFDF;
    font-weight: 500;
    cursor:pointer;
  }

  #adress_modal .selected {
    color: #1C1C1C;
  }

  #adress_modal .allow {
    background-color: white;
    border:thin solid #C2C2C2;
    border-radius: 2px;
    color:#565656;
    font-weight:500;
  }

  .adress_box {
    width:100%;
    height:calc(90% - 30px);
    border:thin solid #DFDFDF;
    border-radius: 3px;

  }

  .btn-common {
    cursor: pointer;
    border: 1px solid black;
    background-color: white;
    width: 90px;
    height: 30px;
    font-weight: 400;
    border-radius: 3px;
    background: #a9abac;
    border-color: #a9abac;
    color: rgb(255, 255, 255);
    font-size:14px;
    vertical-align: middle;
    font-family: "Noto Sans KR", sans-serif;
    float:right;
  }
  .btn-style3 {
    background: white;
    border-color: #B0B0B0;
    color: #1C1C1C;
  }
  .btn-color2 {
    background: #0575E6;
    border: #0575E6;
    color: #FFFFFF;
  }

   </style>
   <?php
   $reply_to = (isset($reply_to))?$reply_to:"";
   $reply_cc = (isset($reply_cc))?$reply_cc:"";
   $reply_title = (isset($reply_title))?$reply_title:"";
   $reply_content = (isset($reply_content))?$reply_content:"";
    ?>
    <div id="main_contents" align="center">
        <div id="send_top" align="left" style="width:95%;padding-bottom:10px;">
          <button type="button" class="btn_basic btn_blue" name="button" id="submit_button" enctype="multipart/form-data" style="width:80px" onclick="chkForm();return false;">보내기</button>
  <!-- <button type="button" class="btn_basic btn_white" name="" style="width:80px">미리보기</button> -->
    <!-- <button type="button" class="btn_basic btn_white" style="width:80px">임시저장</button> -->
    <textarea name="reply_content" id="reply_content" style="display:none;"><?php echo $reply_content; ?></textarea>
    <input type="hidden" id="re_mode" name="re_mode" value="<?php echo $mode; ?>">
        </div>
        <div class="main_div">
          <form action="<?php echo site_url();?>/mail_write/mail_write_action" method="post" enctype="multipart/form-data" id="tx_editor_form" name="tx_editor_form">
        <!-- <input type="text" id="recipient" name="recipient" value="" placeholder="받는 사람"><br> -->

        <table width="90%" class="contents_tbl" border="0" cellspacing="0" cellpadding="0">
          <colgroup>
            <col width=10% align="left">
            <col width=85%>
            <col width=5%>
          </colgroup>

          <tr class="mail_write">
              <td>받는사람</td>
              <td>
                <input type="text" class="input_basic inputsender" id="recipient" name="recipient" value="<?php echo $reply_to; ?>" placeholder="받는 사람" style="width:100%">
              </td>
              <td align="right">
                <!-- <button class="btn_basic btn_white" type="button" id="address_button" name="address_button">주소록</button> -->
                <input class="btn_basic btn_white" type="button" id="address_button" name="address_button" value="주소록">
              </td>
          </tr>


          <tr class="mail_cc">
              <td>참조
                <!-- <span style="font-size:8px;float:right;padding-right:10px;">아래</span> -->
              </td>
              <td>
                <input type="text" class="input_basic inputsender" id="cc" name="cc" value="<?php echo $reply_cc; ?>" placeholder="참조" style="width:100%">
              </td>
              <td>

              </td>
          </tr>

          <tr class="mail_bcc">
              <td>숨은 참조</td>
              <td>
                <input type="text" class="input_basic inputsender" id="bcc" name="bcc" value="" placeholder="숨은 참조" style="width:100%">
              </td>
              <td></td>
          </tr>

          <tr class="mail_title">
            <td>제목
              <!-- <span style="font-size:8px;float:right;padding-right:10px;"><input type="checkbox" name="" value="">중요</span> -->
            </td>
            <td>
              <input type="text" class="input_basic" id="title" name="title" value="<?php echo $reply_title; ?>" placeholder="제목" style="width:100%">
            </td>
            <td></td>
          </tr>
          <tr class="attachment">
              <td>첨부파일</td>
              <td>
                <label class="btn_basic btn_white" for="file_up" style="cursor:pointer;display:block;width:100px;text-align:center;">
                  <span style="color: #1C1C1C; font-size:14px;">파일첨부</span>
                </label>
							  <input type="file" id="file_up" class="file-input" style="display:none;" multiple>
              </td>
              <td></td>
          </tr>
          <tr>
            <td valign="bottom">
              서명<br>
              <select class="" name="" id="signature_list" style="width:95%" onchange="sign_select(this.value)">
                <option value="no">서명없음</option>
<?php
foreach ($sign_list as $sl) {
  $selected = ($sl->active == "Y")? " selected" : "";
  ?>
                <option value="<?php echo $sl->seq; ?>" <?php echo $selected; ?>><?php echo $sl->sign_name; ?></option>
<?php
}
?>
              </select>
            </td>
            <td colspan="2">
              <table class="basic_table" width="100%" height="auto" style="min-height: 60px;border:solid 1px #B0B0B0;">
     							 <tbody id="fileTableTbody">
     									<tr>
     										 <td id="dropZone" align="center" style="color:#B0B0B0;border:none;">
                          마우스로 첨부 할 파일을 끌어오세요.
     										 </td>
     									</tr>
     							 </tbody>
     				 </table>
            </td>
          </tr>

          <tr>
            <td colspan="3">
              <textarea name="content" id="content" style="display:none;"></textarea>
                <input type="hidden" name="contents" id="contents" value="">
                <?php include $this->input->server('DOCUMENT_ROOT')."/misc/daumeditor-7.4.9/editor.php"; ?>
            </td>
          </tr>
        </table>
      </form>
      </div>

    <div id="adress_modal">
      <div style="float:left;width:53%;height:90%;display:flex;flex-direction:column;">
        <div style="width:100%;height:auto;">
          <p style="font-size:20px;font-weight:bold;">주소록</p>
          <p><span style="font-size:14px;font-weight:bold;">주소록검색</span>
            <img id="add_search_btn" style="width: 20px; float:right;position: relative;top: 6px;right: 30px;cursor: pointer;" src="<?php echo $misc; ?>/img/icon/search.png" alt="">
            <input type="text" name="" id="address_search" style="float:right;width:calc(90% - 70px);;" value="" placeholder="이름 또는 이메일 주소로 검색" autocomplete="off">
          </p>
        </div>
        <div style="width:100%;height:auto;border:thin solid #DFDFDF;border-radius:3px;vertical-align:middle;">
          <span type="button" class="btn selected" id="addressspan" onclick="group_button_click('address', this);" name="button">주소록</span>
          <span type="submit" class="btn" id="mboxspan" onclick="group_button_click('mailbox', this);" name="button">메일박스</span>
          <!-- <span type="button" class="btn" onclick="group_button_click('alias');" name="button">그룹메일</span> -->
        </div>

        <!-- <div style="width:calc(100%-1px);height:auto;border:thin solid #DFDFDF;border-radius:3px;vertical-align:middle;">
            <select class="" name="" style="height:100%;width:100%;border:none;">
              <option value="">전체</option>
            </select>
        </div> -->

        <div style="width:100%;height:100%;overflow:auto;border:thin solid #DFDFDF;">
          <table id="group_table" border="0" cellspacing="0" cellpadding="0" style="width:100%;max-height:100%;">
            <colgroup>
              <col width="35%">
              <col width="65%">
            </colgroup>
            <tbody>
            </tbody>
          </table>
        </div>
      </div>
      <div style="float:left;width:7%;height:90%;display:flex;flex-direction:column;">
        <div style="height:13%"></div>
        <div style="height:29%;vertical-align:middle;display:table;text-align:center;">
          <span style="display:table-cell;vertical-align:middle;">
            <button type="button" class="allow" onclick="address_button_click('recipients_tbl');"> > </button><br>
            <button type="button" class="allow" onclick="address_button_click_back('recipients_tbl');"> < </button>
          </span>
        </div>
        <div style="height:29%;vertical-align:middle;display:table;text-align:center;">
          <span style="display:table-cell;vertical-align:middle;">
            <button type="button" class="allow" onclick="address_button_click('cc_tbl');"> > </button><br>
            <button type="button" class="allow" onclick="address_button_click_back('cc_tbl');"> < </button>
          </span>
        </div>
        <div style="height:29%;vertical-align:middle;display:table;text-align:center;">
          <span style="display:table-cell;vertical-align:middle;">
            <button type="button" class="allow" onclick="address_button_click('bcc_tbl');"> > </button><br>
            <button type="button" class="allow" onclick="address_button_click_back('bcc_tbl');"> < </button>
          </span>
        </div>
      </div>
      <div style="float:left;width:40%;height:90%;display:flex;flex-direction:column;">
        <div style="height:13%"></div>
        <div style="height:29%;">
          <p style="font-size:13px;font-weight:bold;padding:0;">
            <span>받는사람</span>
            <span style="margin-left:5px;color:#0575E6"></span>
          </p>
          <div class="adress_box to_item" style="overflow-y:scroll;">
            <table id="recipients_tbl" style="width:100%;">
              <tbody>
              </tbody>
            </table>

          </div>
        </div>
        <div style="height:29%;">
          <p style="font-size:13px;font-weight:bold;">
            <span>참조</span>
            <span style="margin-left:5px;color:#0575E6"></span>
          </p>
          <div class="adress_box to_item" style="overflow-y:scroll;">
          <table id="cc_tbl" style="width:100%;">
            <tbody>
            </tbody>
          </table>
        </div>
        </div>
        <div style="height:29%;">
          <p style="font-size:13px;font-weight:bold;">
            <span>숨은참조</span>
            <span style="margin-left:5px;color:#0575E6"></span>
          </p>
          <div class="adress_box to_item" style="overflow-y:scroll;">
          <table id="bcc_tbl" style="width:100%;">
            <tbody>
            </tbody>
          </table>
        </div>
        </div>
      </div>
      <button type="button" class="btn-common btn-color2" onclick="register_button();" name="button" style="margin-top:20px;">저장</button>
      <button type="button" class="btn-common btn-style3" name="button" onclick="$('#adress_modal').bPopup().close();" style="margin-right:10px;margin-top:20px;">취소</button>
    </div>


    <!-- 모달창 -->
    <!-- <div id="adress_modal2" style="display: none; background-color: white; width: 40vw; height: 70vh;">
      <div id="modal_h">
        <p style="font-size:20px;font-weight:bold;">주소록</p>
        <span style="font-size:14px;font-weight:bold;">주소록검색</span>
        <input type="text" name="" style="margin-left:10px;" value="">

      </div>

      <div id="modal_b">
        <div class="mb_c" style="overflow:auto;" style="width:55%">
          <button type="button" onclick="group_button_click('all');" name="button">전체</button>
          <button type="submit" id="group" onclick="group_button_click('tech');" name="button">그룹</button>
          <button type="button" onclick="group_button_click('salse');" name="button">즐겨찾기</button>

          <table id="group_table">
             <tbody>

              </tbody>
          </table>
        </div>

        <div class="to_contain" style="width:45%">
          <div class="to_item">
            <div style="width:10%">
              <button type="button" onclick="address_button_click('recipients_tbl');"> > </button><br>
              <button type="button" onclick="address_button_click_back('recipients_tbl');"> < </button>
            </div>
            <div class="mb_c" style="width:90%;overflow-y:scroll;">
            <span>받는 사람</span>
              <table id="recipients_tbl">
                <tbody>

                </tbody>
              </table>
            </div>
          </div>

          <div class="to_item">
            <div style="width:10%;">
              <button type="button" onclick="address_button_click('cc_tbl');"> > </button><br>
              <button type="button" onclick="address_button_click_back('cc_tbl');"> < </button>
            </div>
            <div class="mb_c" style="width:90%;overflow-y:scroll;">
            <span>참조</span>
              <table id="cc_tbl">
              <tbody>

              </tbody>
            </table>
          </div>
          </div>

          <div class="to_item">
            <div style="width:10%;">
              <button type="button" onclick="address_button_click('bcc_tbl');"> > </button><br>
              <button type="button" onclick="address_button_click_back('bcc_tbl');"> < </button>
            </div>
            <div class="mb_c" style="width:90%;overflow-y:scroll;">
            <span>숨은참조</span>
              <table id="bcc_tbl">
                <tbody>
                  <tr class="bcc">

                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
    </div>

      <div id="modal_f">
        <button type="button" name="button" onclick="$('#adress_modal').bPopup().close();">취소</button>
        <button type="button" onclick="register_button();" name="button">확인</button>
      </div>
    </div> -->

    <div id="loading_div" style="display:none;">
      <img src="<?php echo $misc; ?>/img/loading.gif" alt="" style="width:100px;">
    </div>
<!-- main_contents 끝 -->
 </div>
  <script>

  $(".inputsender").keyup(function(){
    var inputVal = $(this).val();
    $(this).val(inputVal.replace(/[,]/gi,';'));
  })

  $(function (){
    $("#signature_list").change();
  })

function sign_select(seq){
  var load_content = $("#reply_content").html();
  if(seq =="no"){
    var content = " ";
    content += load_content;
    $("#content").html(content);
    loadContent();
    return false;
  }
  $.ajax({
    url: "<?php echo site_url(); ?>/option/get_signcontent",
    type: 'POST',
    dataType: 'json',
    data: {seq:seq},
    success: function (result) {
      var content = result.sign_content;
      if(content == null){
        content = " ";
      }
      content += load_content;

      $("#content").html(content);
      loadContent();
    }
  });
}


     $('#address_button').bind('click', function(e) {
       $("#address_search").val("");
       $("#addressspan").click();
       e.preventDefault();
        $('#adress_modal').bPopup({
            modalClose : true
           });
         });



      $("#address_search").keydown(function(e){
        const keyCode = e.keyCode;

        if(keyCode == 13){ // Enter key
          $("#add_search_btn").click();
        }
      })


           $("#add_search_btn").click(function(){
              var el = $("#adress_modal .selected");
              if (el.attr("id") == "addressspan") {
                var mode = "address";
              } else {
                var mode = "mailbox";
              }

              group_button_click(mode, el);

           })

           // $("#adress_modal input").click(function(){
           //   console.log("1234141");
           // })


      function group_button_click(mode, el){

        var search_keyword = $("#address_search").val();
        $("#adress_modal .selected").removeClass("selected");
        $(el).addClass("selected");

        $("#group_table tr").remove(); // 한번 띄워주고 테이블 초기화
        $.ajax({
              url:"<?php echo site_url();?>/group/get_user_address",
              type:"GET",
              dataType : 'json',
              data:{
                mode:mode,
                search_keyword: search_keyword
              },
              success: function(result){
                // console.log(result.length);
                if(result.length > 0){
                  // $('#group').text(result);

                  for (var i = 0; i < result.length; i++) {
                    // console.log(result[i].user_name);
                  var name=result[i].name;
                  var email=result[i].email;
                  var tag = "<tr><td height='30' name='select_name_td'>"+ name +"</td>";
                  tag += "<td name='select_mail_td'>"+ email +"</td></tr>";
                  // console.log(tag);
                  $("#group_table tbody").append(tag);
                  // append이용해서 table tr태그를 생성해서 갖다붙임, group_table는 테이블id
                  }

                }
                else{
                  console.log("실패");
                }
               }

             });
     }
     // 주소록에서 클래스 선택,삭제
     $(document).on("click", "#group_table tr", function () {
       var selected=$(this).hasClass("user_selected");
       if(selected){
        $(this).removeClass("user_selected");
       }else{
         $(this).addClass("user_selected");
       }
       });

       //받는사람으로 값 보내기
       function address_button_click(table_id){
        $(".user_selected").each(function(index,obj){

          var contents =$(obj).find('td[name=select_mail_td]').html();
          var tag = "<tr><td>"+ contents +"</td></tr>";
          $("#"+table_id).append(tag);
          $(this).removeClass("user_selected");
        })

       }

       //받는사람table  클래스 선택,삭제
       $(document).on("click", ".to_item table tr", function () {
         var selected=$(this).hasClass("user_selected");
         if(selected){
          $(this).removeClass("user_selected");
         }else{
           $(this).addClass("user_selected");
         }
         });

         // 받는사람table 취소
          function address_button_click_back(table_id){
            // console.log(table_id);
           $("#"+ table_id).find(".user_selected").each(function(){
             $(this).remove(); // 현재 선택된 것만 삭제
           })
          }

         function register_button(){
           // var recipients_length=$("#recipients_tbl >tbody tr").length
           // console.log(recipients_length);
           var recipient_mail = [];
           var cc_mail = [];
           var bcc_mail = [];
           $("#recipients_tbl td").each(function(){
             var td_val = $(this).html(); //$(this).text랑 이양, each반복문으로 하나하나 가져옴
             // td_val = td_val.split(" ")[2];

             recipient_mail.push(td_val);

           })

           $("#cc_tbl td").each(function(){
               var cc_td_val = $(this).html();
               // cc_td_val = cc_td_val.split(" ")[2];
               // console.log(cc_td_val);
               cc_mail.push(cc_td_val);

           })

           $("#bcc_tbl td").each(function(){
               var bcc_td_val = $(this).html();
               // bcc_td_val = bcc_td_val.split(" ")[2];
               // console.log(cc_td_val);
               bcc_mail.push(bcc_td_val);

           });
           recipient_mail = recipient_mail.join("; ");
           $("#recipient").val(recipient_mail); // 모달창 말고 메일쓰기화면에서 받는사람 id값
           cc_mail = cc_mail.join("; ");
           $("#cc").val(cc_mail);
           bcc_mail = bcc_mail.join("; ");
           $("#bcc").val(bcc_mail);
           // console.log(recipient_mail);
           $("#adress_modal").bPopup().close();

         }

         // $("#attachment").change(function(e){
         //   console.log(e);
         // var file = this.files[0].size;
         // // var file = this.files[0].name;
         // console.log(file);
         // })

// 파일 리스트 번호
var fileIndex = 0;
// 등록할 전체 파일 사이즈
var totalFileSize = 0;
// 파일 리스트
var fileList = new Array();
// 파일 사이즈 리스트
var fileSizeList = new Array();
// 등록 가능한 파일 사이즈 MB
var uploadSize = 50;
// 등록 가능한 총 파일 사이즈 MB
var maxUploadSize = 100;

$(function (){
    // 파일 드롭 다운
    fileDropDown();
});

 $("#file_up").change(function(e){
    var file = this.files;

    selectFile(file);

 })
// 파일 드롭 다운
function fileDropDown(){
    var dropZone = $("#dropZone");
    //Drag기능
    dropZone.on('dragenter',function(e){
        e.stopPropagation();
        e.preventDefault();
        // 드롭다운 영역 css
        dropZone.css('background-color','#E3F2FC');
    });
    dropZone.on('dragleave',function(e){
        e.stopPropagation();
        e.preventDefault();
        // 드롭다운 영역 css
        dropZone.css('background-color','#FFFFFF');
    });
    dropZone.on('dragover',function(e){
        e.stopPropagation();
        e.preventDefault();
        // 드롭다운 영역 css
        dropZone.css('background-color','#E3F2FC');
    });
    dropZone.on('drop',function(e){
        e.preventDefault();
        // 드롭다운 영역 css
        dropZone.css('background-color','#FFFFFF');

        var files = e.originalEvent.dataTransfer.files;
               // console.log(e);
        if(files != null){
            if(files.length < 1){
                alert("폴더 업로드 불가");
                return;
            }
            selectFile(files)
        }else{
            alert("ERROR");
        }
    });
}

// 파일 선택시
function selectFile(files){
    // 다중파일 등록
    if(files != null){

        for(var i = 0; i < files.length; i++){
            // 파일 이름
            var fileName = files[i].name;
            var fileNameArr = fileName.split("\.");
            // 확장자
            var ext = fileNameArr[fileNameArr.length - 1];
            // 파일 사이즈(단위 :MB)
            var fileSize = files[i].size / 1024 / 1024;

            if($.inArray(ext, ['exe', 'bat', 'sh', 'java', 'jsp', 'html', 'js', 'css', 'xml']) >= 0){
                // 확장자 체크
                alert("등록 불가 확장자");
                break;
            }else if(fileSize > uploadSize){
                // 파일 사이즈 체크
                alert("용량 초과\n업로드 가능 용량 : " + uploadSize + " MB");
                break;
            }else{
                // 전체 파일 사이즈
                totalFileSize += fileSize;

                // 파일 배열에 넣기
                fileList[fileIndex] = files[i];

                // 파일 사이즈 배열에 넣기
                fileSizeList[fileIndex] = fileSize;

                // 업로드 파일 목록 생성
                addFileList(fileIndex, fileName, fileSize);

                // 파일 번호 증가
                fileIndex++;
            }
        }

    }else{
        alert("ERROR");
    }
}

// 업로드 파일 목록 생성
function addFileList(fIndex, fileName, fileSize){
    var html = "";
    html += "<tr id='fileTr_" + fIndex + "'>";
    html += "    <td class='left' >";
    html +=         fileName + " / " + fileSize + "MB "  + "<a href='#' onclick='deleteFile(" + fIndex + "); return false;' class='btn small bg_02'><img src='<?php echo $misc;?>/img/btn_del2.jpg' style='vertical-align:middle;'></a>";
    html += "    </td>";
    html += "</tr>";

    $('#fileTableTbody').append(html);
}

// 업로드 파일 삭제
function deleteFile(fIndex){
    // 전체 파일 사이즈 수정
    totalFileSize -= fileSizeList[fIndex];

    // 파일 배열에서 삭제
    delete fileList[fIndex];

    // 파일 사이즈 배열 삭제
    delete fileSizeList[fIndex];

    // 업로드 파일 테이블 목록에서 삭제
    $("#fileTr_" + fIndex).remove();
}


var chkForm = function () {
  $("#loading_div").bPopup(
    {
      modalClose: false
    }
  )
  var mform = document.tx_editor_form;

  if (mform.recipient.value == "") {
 		mform.recipient.focus();
      $("#loading_div").bPopup().close();
  		alert("받는사람을 입력해 주세요.");
  		return false;
  	}

    $("#contents").val(Editor.getContent());
  	var formData = new FormData(document.getElementById("tx_editor_form"));

    // file_realname = file_realname.filter(Boolean);
    // file_changename = file_changename.filter(Boolean);
    // formData.append('file_realname', file_realname.join('*/*'));
    // formData.append('file_changename', file_changename.join('*/*'));

    // 등록할 파일 리스트
    var uploadFileList = Object.keys(fileList);

    // 파일이 있는지 체크
    formData.append('file_length', uploadFileList.length);
    if(uploadFileList.length > 0){
        // 용량을 500MB를 넘을 경우 업로드 불가
      if (totalFileSize > maxUploadSize) {
        // 파일 사이즈 초과 경고창
        alert("총 용량 초과\n총 업로드 가능 용량 : " + maxUploadSize + " MB");
        return;
      }
      // 등록할 파일 리스트를 formData로 데이터 입력
      for (var i = 0; i < uploadFileList.length; i++) {
        formData.append('files[]', fileList[uploadFileList[i]]);
      }
    }

    $.ajax({
         url: "<?php echo site_url(); ?>/mail_write/mail_write_action",
         data: formData,
         type: 'POST',
         enctype: 'multipart/form-data',
         processData: false,
         contentType: false,
         dataType: 'json',
         cache: false,
         success: function (result) {
           console.log(result);
            if (result == "success") {
              $("#loading_div").bPopup().close();
              alert("전송되었습니다.");
             location.href ="<?php echo site_url();?>/mail_write/page";
            } else {
              console.log(result);
              alert("전송에 실패하였습니다.");
            }
         }
      });

}




  </script>

<?php
include $this->input->server('DOCUMENT_ROOT')."/include/mail_footer.php";
 ?>
