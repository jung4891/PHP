<?php
header("Content-type: text/html; charset=utf-8");

class STC_Dashboard extends CI_Model {

	function __construct() {

		parent::__construct();
    $this->id = $this->phpsession->get( 'id', 'stc' );
    $this->name = $this->phpsession->get( 'name', 'stc' );
    $this->lv = $this->phpsession->get( 'lv', 'stc' );
    $this->cnum = $this->phpsession->get( 'cnum', 'stc' );
//		$this->user_id = $this->phpsession->get( 'id', 'stc' );
	}

	function notice_list(){
		$sql = "select seq, category_code, subject, user_id, user_name, file_changename, update_date from biz_notice_basic order by seq desc limit 5";

		$query = $this->db->query($sql);

    return $query->result_array();
	}

	function notice_list_count() {
		$sql = "select count(seq) as ucount from biz_notice_basic order by seq desc";

		$query = $this->db->query($sql);

		return $query->row();
	}

	function user_data(){
		$sql = "select user_id, user_name, user_duty, user_email, user_tel, user_group from user order by seq";

		$query = $this->db->query($sql);

		return $query->result_array();
	}

	function schedule(){
		$sql = "select * from tech_schedule_list where participant like '%{$this->name}%'";

		$query = $this->db->query($sql);

		return $query->result_array();
	}

	function attendance_today(){
		$sql = "select work_on_time, work_off_time from attendance where name = '{$this->name}' and work_date = curdate();";

		$query = $this->db->query($sql);

		return $query->result_array();
	}

	function attendance_today_count(){
		$sql = "select count(*) as cnt from attendance where name = '{$this->name}' and work_date = curdate()";

		$query = $this->db->query($sql);

		return $query->row();
	}

	function my_schedule($name) {
	  $sql = "SELECT count(*) as cnt from tech_schedule_list where participant like '%{$name}%' and curdate() between start_day and end_day";
	  $query = $this->db->query($sql);

	  return $query->row();
	}

	function holiday_list($target_date) {
		$sql = "SELECT locdate from holiday where locdate like '{$target_date}%'";

		$query = $this->db->query($sql);

		return $query->result_array();
	}

	function holiday_count($target_date) {
		$sql = "SELECT count(*) as cnt from holiday where locdate like '{$target_date}%'";

		$query = $this->db->query($sql);

		return $query->row();
	}

	function reservartion_room($day) {
	  $sql = "SELECT a.room_name AS room, b.* FROM meeting_room a LEFT JOIN ( SELECT * FROM tech_schedule_list WHERE '{$day}' BETWEEN start_day AND end_day) b ON b.room_name LIKE CONCAT('%',a.room_name,'%') ORDER BY a.room_name DESC;";
	  $query = $this->db->query($sql);
	  return $query->result_array();
	}

	function reservartion_car($day) {
	  $sql = "SELECT a.type, b.* FROM (select * from admin_car where user_name = '공용') a left join (SELECT * FROM tech_schedule_list where '{$day}' BETWEEN start_day AND end_day) b ON concat(a.type,a.number) = b.car_name ORDER BY a.seq";
	  $query = $this->db->query($sql);
	  return $query->result_array();
	}

	function weekly_report_list() {
		$sql = "SELECT * from weekly_report order by seq desc limit 10";

		$query = $this->db->query($sql);

		return $query->result_array();
	}

	function weekly_report_list_count() {
		$sql = "SELECT count(*) as cnt from weekly_report";

		$query = $this->db->query($sql);

		return $query->row();
	}

}
?>
