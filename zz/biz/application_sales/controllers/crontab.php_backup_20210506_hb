<?php
header("Content-type: text/html; charset=utf-8");

class Crontab extends CI_Controller {

	function __construct() {
		parent::__construct();
		$this->load->Model("STC_Crontab");
	}

	function holiday_crontab(){

    $service_key = "64MNVtaO1eTfTnjoRxWoym8WuBjnsF9SYFZfvDnGdq9l08UyjAccxkB9K8Ik5sDxbtX3GJu22hACTnOvcfxdBQ%3D%3D";

		$time = time();
		$date = explode("-",date("Y-m",strtotime("+1 month", $time)));

		$year = $date[0];
		$month = $date[1];

    $url = "http://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService/getRestDeInfo?serviceKey=".$service_key."&solYear=".$year."&solMonth=".$month;

		echo $url;

    $data = file_get_contents($url);
    $xml = simplexml_load_string($data);
    $items = $xml->body[0]->items->item;

    $count = count($items);

    if ($count>0){
      for($i=0;$i<$count;$i++){
        $holiday[$i]['dateName'] = $items[$i]->dateName;
        $holiday[$i]['locdate'] = $items[$i]->locdate;
      }

      echo "<pre>";
      echo var_dump($holiday);
      echo "</pre>";

			foreach($holiday as $h){
				$locdate = $h['locdate'];
				$dateName = $h['dateName'];
				$holiday_count = $this->STC_Crontab->holiday_count($locdate)->cnt;
				if ($holiday_count == 0) {
					$this->STC_Crontab->holiday_insert($locdate, $dateName);
				}
			}
    } else {
      echo "공휴일 없음";
    }

  }


}
?>
