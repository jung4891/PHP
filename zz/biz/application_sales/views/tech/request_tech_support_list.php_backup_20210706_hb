<?php
include $this->input->server('DOCUMENT_ROOT')."/include/base.php";
include $this->input->server('DOCUMENT_ROOT')."/include/sales_top.php";

  // 체크해놓은 seq 가져오기
  $checkSeq ='';
  if(isset($_GET['check_seq']) && $_GET['check_seq']!=''){
    $checkSeq = explode(',',$_GET['check_seq']);
  }
?>
<link rel="stylesheet" href="/misc/css/dashboard.css">
<style>
.person_item{

  height:33%;
  display: flex;
  justify-content: center;
  align-items: center;
  font-family:"Noto Sans KR", sans-serif;
}
</style>
<script type="text/javascript" src="/misc/js/jquery.bpopup-0.1.1.min.js"></script>
<script language="javascript">

window.onload=function(){
   change();
}

function change() {
  var search1 = document.getElementById("search1").value;

  if (search1 == '007') {
    $("#searchkeyword").prop("type", "date");
  } else {
    $("#searchkeyword").prop("type", "text");
  }

  if(search1 == '006'){
    $("#searchkeyword").attr("placeholder", "승인: y , 미승인: n");
  }else{
    $("#searchkeyword").attr("placeholder", "검색하세요.");
  }

  if (search1 == '004') { //장비명
    $("#searchkeyword2").prop("type", "text");
  } else {
    $("#searchkeyword2").prop("type", "hidden");
  }


}

function GoSearch(){
  var searchkeyword = document.mform.searchkeyword.value;
  var searchkeyword = searchkeyword.trim();

  var searchkeyword2 = document.mform.searchkeyword2.value;
  var searchkeyword2 = searchkeyword2.trim();

  if(searchkeyword == ""){
    alert( "검색어를 입력해 주세요." );
    return false;
  }

  document.mform.action = "<?php echo site_url();?>/tech/tech_board/request_tech_support_list";
  document.mform.cur_page.value = "";
  document.mform.submit();
}

</script>
<script language="javascript">
function GoFirstPage (){
  $("input[name=check]").attr("disabled",true);
  document.mform.cur_page.value = 1;
  document.mform.submit();
}

function GoPrevPage (){
  $("input[name=check]").attr("disabled",true);
  var cur_start_page = <?php echo $cur_page;?>;

  document.mform.cur_page.value = Math.floor( ( cur_start_page - 11 ) / 10 ) * 10 + 1;
  document.mform.submit( );
}

function GoPage(nPage){
  $("input[name=check]").attr("disabled",true);
  document.mform.cur_page.value = nPage;
  document.mform.submit();
}

function GoNextPage (){
  $("input[name=check]").attr("disabled",true);
  var cur_start_page = <?php echo $cur_page;?>;
  document.mform.cur_page.value = Math.floor( ( cur_start_page + 9 ) / 10 ) * 10 + 1;
  document.mform.submit();
}

function GoLastPage (){
  $("input[name=check]").attr("disabled",true);
  var total_page = <?php echo $total_page;?>;
  document.mform.cur_page.value = total_page;
  document.mform.submit();
}

function ViewBoard(seq){
  $("input[name=cur_page]").attr("disabled",true);
  $("#search1").attr("disabled",true);
  $("input[name=searchkeyword]").attr("disabled",true);
  $("input[name=searchkeyword2]").attr("disabled",true);
  document.mform.action = "<?php echo site_url();?>/tech/tech_board/request_tech_support_view";
  document.mform.seq.value = seq;
  document.mform.mode.value = "view";

  document.mform.submit();
}
</script>
<body>
  <?php
  include $this->input->server('DOCUMENT_ROOT')."/include/sales_header.php";
?>
<div align="center">
<div class="dash1-1">
  <form name="mform" action="<?php echo site_url();?>/tech/tech_board/request_tech_support_list" method="get" onKeyDown="if(event.keyCode==13) return GoSearch();">
<table width="100%" height="100%" border="0" cellspacing="0" cellpadding="0" class="dash_tbl1-1">
<input type="hidden" name="cur_page" value="<?php echo $cur_page; ?>">
<input type="hidden" id ="seq" name="seq" value="">
<input type="hidden" name="mode" value="">
<input type="hidden" id="check_seq" name="check_seq" value="<?php if(isset($_GET['check_seq'])){ echo $_GET['check_seq']; } ?>"/>
<input type="hidden" id="file_change_name" name="file_change_name" value="<?php if(isset($_GET['file_change_name'])){ echo $_GET['file_change_name']; } ?>"/>
<tbody height="100%">
  <!-- 타이틀 이미지 자리요 -->
<tr height="5%">
  <td class="dash_title"><img src="<?php echo $misc;?>img/dashboard/title_tech_support.png"/></td>
</tr>
<!-- 타이틀 자리 끝이요 -->
<!-- 여기는 검색 자리요 -->
<tr height="10%">
  <td align="left" valign="bottom">
      <table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td width="5%"></td>
        <td>
          <select name="search1" id="search1" class="select7" onChange="change();">
          <option value="001" <?php if($search1 == "001"){ echo "selected";}?>>고객사</option>
          <option value="002" <?php if($search1 == "002"){ echo "selected";}?>>협력사</option>
          <option value="003" <?php if($search1 == "003"){ echo "selected";}?>>사업장명</option>
          <option value="004" <?php if($search1 == "004"){ echo "selected";}?>>장비명</option>
          <option value="009" <?php if($search1 == "009"){ echo "selected";}?>>serial</option>
          <option value="005" <?php if($search1 == "005"){ echo "selected";}?>>진행단계</option>
          <option value="006" <?php if($search1 == "006"){ echo "selected";}?>>최종승인</option>
          <option value="007" <?php if($search1 == "007"){ echo "selected";}?>>설치일자</option>
          <option value="008" <?php if($search1 == "008"){ echo "selected";}?>>세금계산서</option>
          <!-- <option value="009" <?php if($search1 == "009"){ echo "selected";}?>>serial</option> -->
        </select>

        <span>
        <input  type="text" size="25" class="input2" id="searchkeyword" name="searchkeyword" placeholder="검색하세요." value="<?php echo str_replace('"', '&uml;', $search_keyword );?>"/>
        </span>
<span>
  <input  type="hidden" size="25" class="input2" name="searchkeyword2" id="searchkeyword2" placeholder="버전명을 입력하세요." value="<?php echo str_replace('"', '&uml;', $search_keyword2 );?>" />
</span>
        <span>
          <input type="image" style='cursor:hand; margin-bottom:8px;' onClick="return GoSearch();" src="<?php echo $misc;?>img/dashboard/btn/btn_search.png" width="20px" height="20px" align="middle" border="0" />
        </span>
        <!-- <span>
        <input type="text" id="tax_num" style="float:right;display:none;" class="select7">
        </span> -->
        </td>

        <td align="right">
        </td>
        <td align="right">
          <?php if($tech_lv == 3){ ?>

          <!-- <input type="text" id="tax_num" style="display:none;" class="select7" placeholder="승인번호를 입력하세요."> -->
          <span>

            <input type="text" id="tax_num" class="select7" style="display:none;vertical-align:top;" placeholder="승인번호" >
          </span>
          <input type="button" class="skyBtn" value="승인번호 입력" onclick="changeBtn(this);" style="border-radius: 19px;">
          <input type="button" id="taxBtn" class="skyBtn" value="승인번호 저장" style="display:none;margin-left:5px;" onclick="tax();">
          <input type="button" class="skyBtn" value="최종승인" style="margin-left:5px;" onclick="finalApproval();" />
          <img src="<?php echo $misc;?>img/dashboard/btn/btn_delete.png" width="64" height="31" style="margin-left:5px;" onclick="delete_request_tech_support();"/>

          <button class="skyBtn" type="button" name="button" onclick="personopen();">담당자 설정</button>
        <?php } ?>
        </td>
        <td width="5%" align="right">

        </td>

      </tr>
    </table>
  </td>
</tr>
<!-- 검색 끝이요 -->
<!-- 본문 자리요 -->
<tr height="45%">
<td valign="top" style="padding:15px 0px 15px 0px">
    <table class="content_dash_tbl" align="center" width="100%" border="0" cellspacing="0" cellpadding="0">
      <colgroup>
        <col width="4%">
        <col width="5%">
        <col width="8%">
        <col width="8%">
        <col width="8%">
        <col width="8%">
        <col width="13%">
        <col width="13%">
        <col width="9%">
        <col width="5%">
        <col width="5%">
        <col width="5%">
        <col width="5%">
        <col width="4%">
      </colgroup>

      <tr class="t_top">
        <th></th>
        <th height="40" align="center">No.</th>
        <th align="center">고객사</th>
        <th align="center">협력사</th>
        <th align="center">사업장명</th>
        <th align="center">장비명</th>
        <th align="center">설치요청일</th>
        <th align="center">설치일</th>
        <th align="center">장비배송일</th>
        <th align="center">진행단계</th>
        <th align="center">세금계산서</th>
        <th align="center">최종승인</th>
        <th align="center">첨부</th>
        <th></th>
      </tr>
      <?php
        if ($count > 0) {
          $i = $count - $no_page_list * ( $cur_page - 1 );
          $icounter = 0;

          foreach ( $list_val as $item ) {

          if($item['file_change_name']) {
            $strFile = "<img src='".$misc."img/add.png' width='20' height='20' />";
          } else {
            $strFile = "-";
          }
      ?>
      <tr onMouseOver="this.style.backgroundColor='#EAEAEA'" onMouseOut="this.style.backgroundColor='#fff'">
        <td></td>
        <td height="40" align="center">
          <?php if($tech_lv == 3){ ?>
            <input type="checkbox" name="check" value="<?php echo $item['seq'];?>" onchange="checkSeq(this,<?php echo $item['seq'];?>,'<?php echo $item['file_change_name'];?>')" <?php if($checkSeq <> ""){if(in_array($item['seq'],$checkSeq)){echo "checked";};} ?> />
          <?php } ?>
          <?php echo $i;?>
        </td>

        <td align="center">
          <a href="JavaScript:ViewBoard('<?php echo $item['seq'];?>')">
            <?php echo $item['customer_company'];?>
          </a>
        </td>
        <td align="center">
            <?php echo $item['cooperative_company'];?>
        </td>
        <td align="center">
            <?php echo $item['workplace_name'];?>
        </td>
        <td align="center">
            <?php echo $item['produce'];?>
        </td>
        <td align="center">
            <?php if($item['installation_request_date'] != "0000-00-00"){echo $item['installation_request_date'];}else{echo "일정협의";}?>
        </td>
        <td align="center">
            <?php echo $item['installation_date'];?>
        </td>
        <td align="center">
            <?php echo $item['delivery_date'];?>
        </td>
        <td align="center">
            <?php echo $item['result'];?>
        </td>
        <td align="center">
            <?php echo $item['tax'];?>
        </td>
        <td align="center">
            <?php if($item['final_approval'] =='N'){echo "미승인";}else{echo "승인";} ?>
        </td>
        <td align="center">
          <?php echo $strFile; ?>
        </td>
        <td></td>
      </tr>

  <?php
  $i--;
  $icounter++;
  }
} else {
      ?>
        <tr onMouseOver="this.style.backgroundColor='#FAFAFA'" onMouseOut="this.style.backgroundColor='#fff'">
                    <td width="100%" height="40" align="center" colspan="14">등록된 게시물이 없습니다.</td>
                  </tr>
                  <tr>

                  </tr>
      <?php
        }
      ?>

    </table>
</td>
</tr>

<!-- 본문 끝이요 -->
<!-- 페이징 들어갈 자리요 -->
<tr height="40%">
  <td align="left" valign="top">
    <table width="100%" cellspacing="0" cellpadding="0">
    <tr>
      <td width="19%">

        <tr height="20%">
          <td align="center" valign="top">
<?php if ($count > 0) {?>
<table width="400" border="0" cellspacing="0" cellpadding="0">
    <tr>
<?php
if ($cur_page > 10){
?>
      <td width="19"><a href="JavaScript:GoFirstPage()"><img src="<?php echo $misc;?>img/dashboard/btn/btn_first.png" width="20" height="20"/></a></td>
      <td width="2"></td>
      <td width="19"><a href="JavaScript:GoPrevPage()"><img src="<?php echo $misc;?>img/dashboard/btn/btn_left.png" width="20" height="20"/></a></td>
<?php
} else {
?>
<td width="19"></td>
      <td width="2"></td>
      <td width="19"></td>
<?php
}
?>
      <td align="center">
<?php
for  ( $i = $start_page; $i <= $end_page ; $i++ ){
if( $i == $end_page ) {
  $strSection = "";
} else {
  $strSection = "&nbsp;<span class=\"section\">&nbsp&nbsp</span>&nbsp;";
  // $strSection = "&nbsp;<span class=\"section\">|</span>&nbsp;";
}

if  ( $i == $cur_page ) {
  echo "<a href=\"JavaScript:GoPage( '".$i."' )\" class=\"alink\"><font color=\"#33ccff\">".$i."</font></a>".$strSection;
} else {
  echo "<a href=\"JavaScript:GoPage( '".$i."' )\" class=\"alink\">".$i."</a>".$strSection;
}
}
?></td>
      <?php
if   ( floor( ( $cur_page - 1 ) / 10 ) < floor( ( $total_page - 1 ) / 10 ) ){
?>
<!-- <td width="19"><a href="JavaScript:GoNextPage()"><img src="<?php echo $misc;?>img/dashboard/page_next.png" width="20" height="20"/></a></td> -->
      <td width="2"></td>
      <td width="19"><a href="JavaScript:GoNextPage()"><img src="<?php echo $misc;?>img/dashboard/btn/btn_right.png" width="20" height="20"/></a></td>
      <td width="19"><a href="JavaScript:GoLastPage()"><img src="<?php echo $misc;?>img/dashboard/btn/btn_last.png" width="20" height="20"/></a></td>
<?php
} else {
?>
<td width="19"></td>
      <td width="2"></td>
      <td width="19"></td>
<?php
}
?>


</tr>
</table>
<?php }?>
</td>
</tr>
</td>
</tr>

<tr>
  <td width="19%">
    <tr>
      <td height="10"></td>
    </tr>
<?php if($tech_lv > 0) {?>
<tr>
  <td align="center" colspan="8" style="padding-bottom:25px"><a href="<?php echo site_url();?>/tech/tech_board/request_tech_support_input"><img src="<?php echo $misc;?>img/dashboard/btn/btn_write.png" width="90" height="35"/></td>
</tr>
<?php }?>
<tr>
  <td height="10"></td>
</tr>
</td>
</tr>
</table>
</td>
</tr>
<!-- 페이징 끝이오 -->

</tbody>
</table>
</form>
</div>
</div>

<!-- 창 -->
<div id="person_div" style="height:30%;width:30%;background-color:#ffffff; border-radius:2em;display:none;">

    <div class="person_item" style="font-size:24px;font-weight:bold;">
     담당자 설정
     <input type="hidden" name="person_seq" id="person_seq" value="<?php echo $responsibility->seq ?>">
    </div>
    <div class="person_item" style="font-size:18px; color:#a19d9d;font-weight:bold;">
			<form method="post" id="qform">
      담당자1
      <select class="select7" name="person1" id="person1">
        <option value="">선택하세요</option>
        <?php
        $select_seq = $responsibility->person1;
        foreach ($durian_engineer as $eng){
          $selected = $select_seq == $eng['seq'] ? " selected" : "";
          echo "<option value='{$eng['seq']}'{$selected}>{$eng['user_name']}</option>";
       }
       ?>
      </select><br>
      담당자2
      <select class="select7" name="person2" id="person2">
        <option value="">선택하세요</option>
        <?php
        $select_seq = $responsibility->person2;
        foreach ($durian_engineer as $eng){
          $selected = $select_seq == $eng['seq'] ? " selected" : "";
          echo "<option value='{$eng['seq']}'{$selected}>{$eng['user_name']}</option>";
       }
       ?>
      </select>
		</form>
    </div>
    <div class="person_item">
			<!-- <label for="copy_submit"> -->
      <button type="button" name="button" class="skyBtn" style="width:70px" onclick="change_person();">확인</button>
		<!-- </label> -->
      <button type="button" name="button" class="skyBtn" style="background-color:#FF6666;width:70px" onclick="$('#person_div').bPopup().close();">취소</button>
    </div>
</div>
<script>
function personopen(){
	$("#person_div").bPopup({
		speed: 450,
		transition: 'slideDown'
	})
}

function change_person(){
  $.ajax({
    type: "POST",
    cache: false,
    url: "<?php echo site_url(); ?>/tech/tech_board/change_function",
    dataType: "json",
    async: false,
    data: {
      seq: $("#person_seq").val(),
      person1:$("#person1").val(),
      person2:$("#person2").val()
    },
    success: function (data) {
      console.log(data);
      if(data == '실패'){
        alert("저장하지 못했습니다. 다시 처리해 주시기 바랍니다.");
      }else{
        alert("저장하였습니다.");
        $("#person_div").bPopup().close();
      }
    }
  });
}

  function checkSeq(obj,seq,filename){
    if($(obj).is(":checked")==true){
      if($("#check_seq").val() == ""){
        $("#check_seq").val($("#check_seq").val()+seq);
        $("#file_change_name").val($("#file_change_name").val()+filename);
      }else{
        $("#check_seq").val($("#check_seq").val()+","+seq);
        $("#file_change_name").val($("#file_change_name").val()+","+filename);
      }
    }else{
      if($("#check_seq").val().indexOf(","+seq) != -1) {
        $("#check_seq").val($("#check_seq").val().replace(","+seq,''));
        $("#file_change_name").val($("#file_change_name").val().replace(","+filename,''));
      }else if($("#check_seq").val().indexOf(seq+",") != -1){
        $("#check_seq").val($("#check_seq").val().replace(seq+",",''));
        $("#file_change_name").val($("#file_change_name").val().replace(filename+",",''));
      }else{
        $("#check_seq").val($("#check_seq").val().replace(seq,''));
        $("#file_change_name").val($("#file_change_name").val().replace(filename,''));
      }
    }
  }

  function finalApproval(){
    var result = confirm("최종승인 하시겠습니까?");
    if(result){
      $.ajax({
        type: "POST",
        cache: false,
        url: "<?php echo site_url(); ?>/tech/tech_board/finalApproval",
        dataType: "json",
        async: false,
        data: {
          seq: $("#check_seq").val()
        },
        success: function (data) {
          if(data){
            alert('승인완료');
            location.href = "<?php echo site_url(); ?>/tech/tech_board/request_tech_support_final_approval_mail?seq="+$("#check_seq").val();
          }else{
            alert('승인오류');
          }
        }
      });
    }else{
      location.href = "<?php echo site_url(); ?>/tech/tech_board/request_tech_support_list";
    }
  }

  function tax(){
    if($("#check_seq").val() == ''){
      alert("승인번호를 입력 할 게시물을 선택해주세요.");
    }else{
      var result = confirm("세금계산서 승인번호를 저장하시겠습니까?");
      if(result){
        $.ajax({
          type: "POST",
          cache: false,
          url: "<?php echo site_url(); ?>/tech/tech_board/taxNumber",
          dataType: "json",
          async: false,
          data: {
            seq: $("#check_seq").val(),
            tax: $("#tax_num").val()
          },
          success: function (data) {
            if(data){
              alert('세금계산서 승인번호 저장');
              location.href = "<?php echo site_url(); ?>/tech/tech_board/request_tech_support_list";
            }else{
              alert('세금계산서 승인번호 저장오류');
            }
          }
        });
      }else{
        location.href = "<?php echo site_url(); ?>/tech/tech_board/request_tech_support_list";
      }
    }
  }

  function changeBtn(obj){
    $(obj).hide();
    $("#tax_num").show();
    $("#taxBtn").show();
  }

  function delete_request_tech_support(){
    if (confirm("정말 삭제하시겠습니까?") == true){
        var mform = document.cform;
        location.href = "<?php echo site_url();?>/tech/tech_board/request_tech_support_delete_action?seq="+$("#check_seq").val()+"&file_change_name="+$("#file_change_name").val();
        // mform.submit();
        // return false;
    }
  }
</script>
<?php
 include $this->input->server('DOCUMENT_ROOT')."/include/sales_bottom.php";
?>
</body>
</html>
